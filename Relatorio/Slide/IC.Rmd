---
title: "An√°lise da Exced√™ncia de Limiar de Oz√¥nio Troposf√©rico por meio de Regress√£o Log√≠stica para Dados Periodicamente Correlacionados"
author: "Andrey Alexandre de Souza Basilio e Alessandro Jos√© Queiroz Sarnaglia"
institute: "Universidade Federal do Espirito Santo"
date: "11/11/2020"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

# Introdu√ß√£o

- Os poluentes s√£o divididos entre prim√°rios e secund√°rios;

- Oz√¥nio Troposf√©rico causa agravamento de doen√ßas respirat√≥rias;

- Estudos anteriores indicam 80 ùõçg/m¬≥  como concentra√ß√£o limiar de Oz√¥nio;

- Revis√£o bibliogr√°fica indica presen√ßa de correla√ß√£o peri√≥dica;

- O estudo prop√µe o modelo de Regress√£o Log√≠stica com Autocorrela√ß√£o Per√≠odica.

---
class: inverse, center, middle

# Metodologia

---

# Regress√£o Log√≠stica

A vari√°vel $Y_i$ segue o modelo log√≠stico se $Y_i|X_i \sim \text{Bernoulli}(\vartheta_t)$, em que $\vartheta_t$ denota a probabilidade de sucesso e satisfaz 
$$\eta(\vartheta_t) = \text{logit}(\vartheta_t) = \log \left( \frac{\vartheta_t}{1-\vartheta_t} \right) = X_i'\beta,$$
e $X_i$ e $\beta$ denotam, respectivamente, os vetores de covari√°veis e de par√¢metros. Outras fun√ß√µes de liga√ß√£o podem ser consideradas em vez de logit.

--

Os modelos de Regress√£o Log√≠stica n√£o s√£o desenhados para acomodar autocorrela√ß√£o. Podemos usar o modelo desenvolvido por Azzalini (1994), que √© capaz de explicar esse fen√¥meno.

---

# Regress√£o Log√≠stica com Autocorrela√ß√£o

Proposto por Azzalini (1994), o modelo de Regress√£o Log√≠stica com Autocorrela√ß√£o (RLA) √© capaz de explicar a estrutura de autocorrela√ß√£o nos dados via Cadeias de Markov. 

--

Para isso, o valor esperado √© $\vartheta=E(Y_t)$ e o coeficiente de autocorrela√ß√£o $\rho=\text{Corr}(Y_t,Y_{t-1})$. Desta forma as probabilidades de transi√ß√£o s√£o dadas por
\begin{multline*}
p_j = P(Y_t=1|Y_{t-1}=j) = \\
\vartheta_t - \rho\left(\vartheta_t(1-\vartheta_t)\frac{\vartheta_t}{1-\vartheta_t}\right)^{1/2}+ \\
j\rho[\vartheta_t(1-\vartheta_t)]^{1/2}\left[ \left( \frac{1-\vartheta_t}{\vartheta_t} \right)^{1/2} + \left( \frac{\vartheta_t}{1-\vartheta_t} \right)^{1/2}\right].
\end{multline*}

---

# Regress√£o Log√≠stica com Autocorrela√ß√£o

Assumindo $\eta(\vartheta_t)=\text{logit}(\vartheta_t)=X_t'\beta$, escrevemos a log-verossimilhan√ßa como
$$l(\beta, \rho) = \sum_{t=1}^T y_t\text{logit}(p_{y_{t-1}}) + \sum_{t=1}^T \text{ln}(1-p_{y_{t-1}}),$$
onde $p_{y_0} = \vartheta_1$.

--

O Estimador de M√°xima Verossimilhan√ßa (EMV) de ( $\beta$, $\rho$) √© dado por $(\hat{\beta}, \hat{\rho}) = \text{argmax} [l(\beta, \rho)]$.

---

# Regress√£o Log√≠stica com Autocorrela√ß√£o Peri√≥dica

Tendo em vista fen√¥menos que possuem correla√ß√£o peri√≥dica, como a emiss√£o de poluentes atmosf√©ricos, √© proposto o modelo de Regress√£o Log√≠stica com Autocorrela√ß√£o Peri√≥dica, que generaliza o modelo RLA no cen√°rio de periodicidade na estrutura de autocorrela√ß√£o.

--

O √≠ndice temporal ser√° reescrito como $t = t(r,m) = (r-1)s + m$, $m=1,\ldots,s$, $r \in \mathbb{Z}$, em que $s$ denota o tamanho do per√≠odo, e $r$ e $m$ representam, respectivamente, o c√≠clo e o per√≠odo correspondentes ao √≠ndice $t=t(r,m)$.

---

# Regress√£o Log√≠stica com Autocorrela√ß√£o Peri√≥dica

De maneira similar ao RLA, usamos $\vartheta_t= \vartheta_{t(r,m)}$ e de $\rho_{t(r,m)}=\text{Cor}(Y_{t(r,m)}, _{t(r,m)-1})$. Desta forma as probabilidades de transi√ß√£o s√£o dadas por
\begin{multline*}
p_{j,m} = \vartheta_{t(r,m)} - \rho_m\left(\vartheta_{t(r,m)}(1-\vartheta_{t(r,m)})\frac{\vartheta_{t(r,m)}}{1-\vartheta_{t(r,m)}}\right)^{1/2} +\\ j\rho_m[\vartheta_{t(r,m)}(1-\vartheta_{t(r,m)})]^{1/2}\left[ \left( \frac{1-\vartheta_{t(r,m)}}{\vartheta_{t(r,m)}} \right)^{1/2} + \left( \frac{\vartheta_{t(r,m)}}{1-\vartheta_{t(r,m)}} \right)^{1/2}\right].
\end{multline*}

--

A log-verossimilhan√ßa do modelo RLAP √© dada por
$$l(\beta, \rho) = \sum_{t=1}^T y_t\text{logit}(p_{y_{t-1}}) + \sum_{t=1}^T \text{ln}(1-p_{y_{t-1}}),$$
em que $\rho = (\rho_1, \dots, \rho_s)$.

---

# Regress√£o Log√≠stica com Autocorrela√ß√£o Peri√≥dica

A maximiza√ß√£o envolvida na obten√ß√£o das estimativas do EMV dos modelos RLA e RLAP s√£o realizadas por meio de m√©todos de otimiza√ß√£o num√©rica e os erros-padr√£o s√£o aproximados pela diagonal da inversa da Hessiana da Verossimilhan√ßa. 

--

As derivadas de primeira e segunda ordem foram calculadas analiticamente para melhorar a efici√™ncia dos algoritmos de otimiza√ß√£o num√©rica.

---

# Sele√ß√£o de Covari√°veis

A sele√ß√£o de covari√°veis √© uma etapa comumente realizada no processo de modelagem estat√≠stica. Os m√©todos de estima√ß√£o retrativa  ( $\textit{Shrinkage estimation}$) t√™m se popularizado na literatura (Tibshirani, 1996).

Dentre os m√©todos de estima√ß√£o retrativa, podemos citar o m√©todo Ridge, que apresenta uma penaliza√ß√£o quadr√°tica e o m√©todo Lasso, que apresenta uma penaliza√ß√£o em valor absoluto. Devido √† aus√™ncia de propriedades de interesse no m√©todo Lasso, foi proposto o m√©todo Lasso Adaptativo. Este m√©todo √© definido como a solu√ß√£o do problema de minimiza√ß√£o com restri√ß√£o a seguir:
$$ \hat{\beta} = \text{argmin}  -l(\beta, \rho) + \lambda \sum_{j=1}^pw_j|\beta_j| ,$$
onde os pesos $w_j$ sao estabelecidos $\textit{a priori}$.

---

# Sele√ß√£o de Covari√°veis
Devido as suas vantagens, neste estudo, o m√©todo ALASSO ser√° utilizado para realizar a sele√ß√£o de covari√°veis. Para o modelo RL, o ALASSO j√° se encontra implementado no software R no pacote $\texttt{glmnet}$ fun√ß√£o $\texttt{cv.glmnet}$. Para os modelos RLA e RLAP foram o ALASSO teve que ser inteiramente implementado, sendo que a otimiza√ß√£o com restri√ß√£o foi realizada por meio do algoritmo $\texttt{Orthant-Wise Quasi-Newton Limited-Memory}$ implementado pela fun√ß√£o $\texttt{lbfgs}$ do pacote $\texttt{lbfgs}$ do software $\texttt{R}$.

---

# An√°lise de desempenho do modelo

O previsor um passo a frente para o caso RL √© igual a 1 caso $\vartheta_{n+1} \geq \tau$ e igual a 0 caso $\vartheta_{n+1} < \tau$, onde $\tau$ representa algum limiar determinado de acordo com os interesses do estudo.

--

No caso do RLAP, o previsor um passo-a-frente ser√° igual a 1 caso $Y_{n} = 0 \text{ e } p_0 \geq \tau_{0, m} \text{ ou } Y_{n} = 1 \text{ e } p_1 \geq \tau_{1, m}$ e 0 caso $Y_{n} = 0 \text{ e } p_0 < \tau_{0, m} \text{ ou } Y_{n} = 1 \text{ e } p_1 < \tau_{1, m}$, onde os limiares $\tau_{0, m}$ e $\tau_{1, m}$ tamb√©m s√£o determinados de acordo com o interesse do estudo.

---

# An√°lise de desempenho do modelo

Dentre as poss√≠veis m√©tricas de avalia√ß√£o de desempenho de um modelo para respostas bin√°rias, ser√£o utilizadas a Sensibilidade (SEN) e a Especif√≠cidade (ESP). Estas m√©tricas s√£o definidas por
$$\text{SEN} = \text{P}(Y_t = 1|\hat{Y}_{t-1} (1) = 1) \text{ e ESP}=\text{P}(Y_t = 0|\hat{Y}_{t-1} (1) = 0).$$

--

A estrat√©gia para encontrar os limiares $\tau$, $\tau_{0, m}$ e $\tau_{1, m}$ consistir√° em escolher esses valores de modo que se maximize a sensibilidade com a restri√ß√£o de que a especificidade seja maior ou igual a um valor toler√°vel, que foi fixado em 80\%. O problema de otimiza√ß√£o para o modelo RL √© escrito como 
$$f(\tau)=1-SEN(\tau) + \lambda \times \max(0,ESP_{tar}-ESP(\tau)).$$

--

Enquanto no caso do modelo RLA e RLAP, estrat√©gia semelhante foi adotada, no entanto, a fun√ß√£o a ser minimizada √©
$$f(\tau_0, \tau_1)=1-SEN(\tau_0, \tau_1) + \lambda \times \max(0,ESP_{tar}-ESP(\tau_0, \tau_1)),$$
em que $\tau_0=(\tau_{0,1}, \dots\ \tau_{0,s})$ e $\tau_1=(\tau_{1,1}, \dots\ \tau_{1,s})$

---
class: inverse, center, middle

# Simula√ß√£o

---

# Cen√°rios

Foi realizado um experimento de Monte Carlo com o intuito de averiguar o desempenho dos estimadores e a capacidade preditiva dos modelos RL, RLA e RLAP. No total, foram investigados quatro cen√°rios: 
1. sem autocorrela√ß√£o;
2. com autocorrela√ß√£o ( $\rho = 0.5$ );
3. com autocorrela√ß√£o peri√≥dica com periodicidade mais fraca ( $\underset{\sim}{\rho} = (0.3, 0.2, 0.3, 0.3, 0.3, 0.4, 0.3)$ ); e
4. com autocorrela√ß√£o peri√≥dica com periodicidade mais forte ( $\underset{\sim}{\rho} = (0.5, 0.3, 0.1, -0.2, -0.4, -0.2, 0.2)$ ).

--

Os cen√°rios (3) e (4) ser√£o utilizados para investigar o efeito da m√° especifica√ß√£o no p-valor do teste de signific√¢ncia do coeficiente de uma covari√°vel, enquanto os cen√°rios (1), (2) e (4) ser√£o utilizados para realizar a compara√ß√£o dos modelos em termos de Raiz do Erro Quadr√°tico M√©dio das estimativas e de desempenho preditivo.

---

# Poder do teste - Cen√°rio de autocorrela√ß√£o peri√≥dica com periodicidade mais fraca

.center[![trachoma](A/TestPower_Fraca.png)]

---

# Poder do teste - Cen√°rio de autocorrela√ß√£o peri√≥dica com periodicidade mais forte


.center[![trachoma](A/TestPower_Forte.png)]

---

# Estima√ß√£o - Betas

.center[![trachoma](A/BoxPlot_Betas.png)]

---

# Estima√ß√£o - Rho's

.center[![trachoma](A/BoxPlot_Rho.png)]

---

# Estima√ß√£o - Betas

.center[![trachoma](A/RMSE_Beta.png)]

---

# Estima√ß√£o - Rho's

.center[![trachoma](A/RMSE_Rho.png)]

---

# M√©tricas - Intra-amostrais

.center[![trachoma](A/Metricas_Intra.png)]

---

# M√©tricas - Extra-amostrais

.center[![trachoma](A/Metricas_Extra.png)]

---
class: inverse, center, middle

# Aplica√ß√£o

---

# Dados

Os dados foram obtidos do IEMA, coletados dados sobre poluentes e vari√°veis meteorol√≥gicas atrav√©s da Rede Autom√°tica de Monitoramento da Qualidade do Ar. 

Foram analisados os dados de 2010 a 2017, sendo que 2016 e 2017 foram separados previamente para teste da capacidade preditiva dos modelos.

--

Tamb√©m foram obtidos dados sobre o √çndice do Ni√±o Oce√¢nico. De forma resumida, o ONI representa oscila√ß√µes na temperatura normal da superf√≠cie do mar, na regi√£o 3.4. 

O conjunto de dados da ONI esta dispon√≠ƒ±vel gratuitamente no site da National Oceanic and Atmospheric administration.

---

# Estrat√©gias de Pondera√ß√£o
Foram utilizadas tr√™s estrat√©gias de pondera√ß√£o para o ALASSO:

1. em que todos os dados tem o mesmo peso no ajuste da regress√£o (denominada de $\textit{Unweighted}$ (UL)); 
2. em que s√£o atribu√≠dos pesos linearmente crescentes ao passo que as observa√ß√µes se tornam mais atuais (denominada de $\textit{Weighted}$ (WL)), mais especificamente, nessa estrat√©gia, √© atribu√≠do peso $\frac{t}{n}$ a observa√ß√£o $Y_t,\  t = 1,\dots, n$; e 
3. em que, novamente, s√£o atribu√≠dos pesos linearmente crescentes, entretanto desta vez o peso $\frac{t}{\#(Y=Y_t)}$ √© atribuido a observa√ß√£o $Y_t,\  t = 1,\dots, n$  (denominada de $\textit{Proportional Weighted}$ (PWL)).

---

# Desempenho preditivo

O desempenho preditivo foi avaliado em cen√°rio intra-amostral, com os dados de 2010 e 2015, e extra-amostral, com os dados de 2016 e 2017.
```{r include=FALSE}
library(tidyverse)
```

```{r echo=FALSE}
tribble(
  ~'Modelo' , ~'M√©trica', ~'UL' , ~'WL' , ~'PWL' ,
  "RL"      , "ESP"     , 0.074 , 0.12  , 0.091  ,
  "RL"      , "SEN"     , 0.9   , 0.875 , 0.9    ,
  "RL"      , "ACC"     , 0.119 , 0.161 , 0.135  ,
  "RLA"     , "ESP"     , 0.323 , 0.234 , 0.247  ,         
  "RLA"     , "SEN"     , 0.8   , 0.5   , 0.8    ,
  "RLA"     , "ACC"     , 0.349 , 0.249 , 0.278  ,
  "RLAP"    , "ESP"     , 0.46  , 0.511 , 0.553  , 
  "RLAP"    , "SEN"     , 0.425 , 0.325 , 0.5    ,
  "RLAP"    , "ACC"     , 0.458 , 0.501 , 0.55 )  %>% 
knitr::kable(format = 'html')
```

---

# Conclus√£o

 A sele√ß√£o de covari√°veis foi realizada por meio do m√©todo LASSO adaptativo sob tr√™s estrat√©gias de pondera√ß√£o (sem pondera√ß√£o, com pondera√ß√£o para as observa√ß√µes mais recentes e com pondera√ß√£o pelo inverso da propor√ß√£o das classes) em cada um dos modelos e o ajuste final foi executado via m√°xima verossimilhan√ßa considerando-se as covari√°veis retidas na etapa de sele√ß√£o via LASSO Adaptativo. 

--

Em termos de acur√°cia e especificidade, a estrat√©gia de pondera√ß√£o pelo inverso da propor√ß√£o das classes para o modelo RLAP apresenta melhores resultados de acur√°cia. Notou-se que o modelo RLAP apresentou o melhor desempenho preditivo.



